###########################################
#######Author : Ekam Singh Walia   ########
###########################################
##THIS SCRIPT IS FOR UBUNTU DISTRO ONLY WILL ADD MITIGATION SCRIPT FOR OTHER DISTRO AS WELL######
echo "####DETECTING WHETHER MODSECURITY IS ON YOUR SYSTEM####"

var1=$(dpkg -l | grep -E "mod-sec|modsec")
var2=$(dpkg -l | grep -E "modsec" | awk 'BEGIN{OFS=":"} {print $2,$3}')

if [[ -n $var1 ]]
then
        echo "You have modsecurity on your system whose version is $var2"
fi

echo "Detecting if you are vulnerable to CVE-2021-42717"
var3=$(cat modsecurity.conf | grep -i -E "\bSecRequestBodyNoFilesLimit\b" | awk '{print $2}')
var4=$(cat modsecurity.conf | grep -i -E "\bSecRequestBodyNoFilesLimit\b")
if [[ $var3 -gt 50000 ]]
then
        echo "You are vulnerable to CVE-2021-42717"
        read -p "Do you want to mitigate?? [y/n] :" var5
        if [[ $var5 == y ]]
        then
                sed -i "s/$var4/SecRequestBodyNoFilesLimit 50000/g" modsecurity.conf
                echo "Mitigation has been completed"
        else
                echo "Exiting"
                exit
        fi
else
        echo "You are already save from CVE-2021-42717"
fi
