package com.example;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.SpringBootVersion;
import org.springframework.core.SpringVersion;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.util.UriComponentsBuilder;
import java.util.StringJoiner;

@SpringBootApplication
public class App {
    public static void main(String[] args) {
        SpringApplication.run(App.class, args);
    }
}

@RestController
@RequestMapping("/")
class IntroductionController {
    @GetMapping
    public String introduction() {
        String javaVersion = System.getProperty("java.version");
        String osVersion = System.getProperty("os.name") + " " + System.getProperty("os.version");
        String springFrameworkVersion = SpringVersion.getVersion();
        String springBootVersion = SpringBootVersion.getVersion();

        StringJoiner htmlBuilder = new StringJoiner("\n");

        htmlBuilder.add("<!DOCTYPE html>")
                   .add("<html>")
                   .add("<head>")
                   .add("<title>Proof of Concept - CVE-2024-22262</title>")
                   .add("<link rel=\"stylesheet\" type=\"text/css\" href=\"/css/styles.css\">")
                   .add("<style>")
                   .add("body { font-family: Arial, sans-serif; margin: 20px; }")
                   .add("h1 { color: #333; }")
                   .add("p { line-height: 1.6; }")
                   .add(".logo { width: 150px; }")
                   .add("</style>")
                   .add("</head>")
                   .add("<body>")
                   .add("<h1>Proof of Concept for CVE-2024-22262</h1>")
                   .add("<p><strong>Spring Framework Version:</strong> " + springFrameworkVersion + "</br>")
                   .add("<strong>Spring Boot Version:</strong> " + springBootVersion + "</br>")
                   .add("<strong>Java Version:</strong> " + javaVersion + "</br>")
                   .add("<strong>Operating System Version:</strong> " + osVersion + "</p>")

                   .add("<table>")
                   .add("<tr><td><strong><a href='https://www.herodevs.com/vulnerability-directory'>HeroDevs Vulnerability Directory Entry</a>:</strong></td>")
                   .add("<td><a href='https://www.herodevs.com/vulnerability-directory/cve-2024-38829'>https://www.herodevs.com/vulnerability-directory/cve-2024-38829</a></td></tr>")
                   .add("<tr><td><strong>Spring.io: Vulnerability Directory Entry:</strong></td>")
                   .add("<td><a href='https://spring.io/security/cve-2024-22262'>https://spring.io/security/cve-2024-22262</a></td></tr>")
                   .add("</table>")

                   .add("<p>Use the command below or construct your own.</p>")

                   .add("<div class=\"code-container\">")
                   .add("<button class=\"copy-button\" onclick=\"copyToClipboard('exampleCode')\">Copy Code</button>")
                   .add("<pre id=\"exampleCode\">")
                   .add("    curl -i -X GET 'http://your-vulnerable-app.com/redirect?uri=https://attacker.com?originalUrl=http://legitimate.com'\n")
                   .add("</pre>")
                   .add("</div>")

                   .add("<p>Try the <a href='https://localhost:8081/redirect?uri=https%3A%2F%2Fattacker.com&originalUrl=http%3A%2F%2Flegitimate.com' target='_blank'>code above</a> (opens new tab).</p>")

                   .add("<img src=\"/images/HeroDevsLogo.jpg\" alt=\"Logo\" class=\"logo\">")
                   .add("<script src=\"/js/copy-code.js\"></script>")
                   .add("</body>")
                   .add("</html>");

        return htmlBuilder.toString();
    }
}
@RestController
class RedirectController {
    @GetMapping("/redirect")
    public String redirect(@RequestParam String uri) {
        // Vulnerable code:
        UriComponentsBuilder builder = UriComponentsBuilder.fromUriString(uri);
        String targetUrl = builder.build().toUriString();

        // This would typically be where you might redirect or use this URL
        return "Redirecting to: " + targetUrl;
    }
}
